<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Documento sin título</title>
<meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">
<link href="jquery-mobile/jquery.mobile.theme-1.0.min.css" rel="stylesheet" type="text/css" />
<link href="jquery-mobile/jquery.mobile.structure-1.0.min.css" rel="stylesheet" type="text/css" />
<script src="jquery-mobile/jquery-1.6.4.min.js" type="text/javascript"></script>
<script src="jquery-mobile/jquery.mobile-1.0.min.js" type="text/javascript"></script>
<script>
function getParameterByName(name) 
	{
    name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
    results = regex.exec(location.search);
    return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
	}
var usuario = getParameterByName('usuario');
var password = getParameterByName('password');
var nombre_usuario = getParameterByName('nombre_usuario');

console.log("usuario:"+usuario+" --");
console.log("password:"+password+" --");
console.log("nombre:"+nombre_usuario+" --");

$(document).ready(function() 
	{
		
		var dato="LECTURA";
		var code="";
		var formData = new FormData();
		formData.append("code", code);
		formData.append("dato", dato);
		formData.append("usuario", nombre_usuario);
		$.ajax({
			type: 'POST',
			url: 'https://www.sistemalodis.cl/bodega_lodis_movil/checklist_comercio_guarda_dato_app.php',
			data: formData,
			processData: false,
			contentType: false,
			success: function (result) 
				{
				console.log(result);
				var obj = JSON.parse(result);
				if (obj.venta!=null)
					{
					$('#venta').empty().append();
					$('#venta').append('<option value="'+obj.venta+'">'+obj.venta+'</option>');
					$('#venta').append('<option value="SI WOM">SI WOM</option>');
					$('#venta').append('<option value="NO WOM SI OTRAS TELCO">NO WOM SI OTRAS TELCO</option>');
					$('#venta').append('<option value="SOLO RECARGA">SOLO RECARGA</option>');
					$('#venta').selectmenu('refresh')
					}
				document.getElementById('id_comercio').value=obj.id_comercio;
				document.getElementById('direccion').value=obj.direccion;
				document.getElementById('nombre_contacto').value=obj.nombre_contacto;
				document.getElementById('telefono_contacto').value=obj.telefono_contacto;
				if (obj.tipo_canal!=null)
					{
					$('#tipo_canal').empty().append();
					$('#tipo_canal').append('<option value="'+obj.tipo_canal+'">'+obj.tipo_canal+'</option>');
					$('#tipo_canal').append('<option value="ESPECIALISTA">ESPECIALISTA</option>');
					$('#tipo_canal').append('<option value="TRADICIONAL">TRADICIONAL</option>');
					$('#tipo_canal').append('<option value="KIOSCO">KIOSCO</option>');
					$('#tipo_canal').selectmenu('refresh')
					}
				document.getElementById('total_productos').innerHTML = obj.total_productos;
				
				if (obj.comunas!='')
					{
					$('#comuna').empty().append();
					$('#comuna').append('<option value="'+obj.comuna+'">'+obj.comuna+'</option>');
					for (i=0;i<obj.comunas.length;i++)
						{
						$('#comuna').append('<option value="'+obj.comunas[i]+'">'+obj.comunas[i]+'</option>');
						}
					
					$('#comuna').selectmenu('refresh')
					}
				
				
				
				}
			});
		
	})

function carga_scanner()
		{
		location.href="comercio_scanner.html?usuario="+usuario+"&password="+password+"&nombre_usuario="+nombre_usuario+"";
		}
function guardar_dato(dato)
	{
	var venta = document.getElementById("venta").value;
	//var nombre_local = document.getElementById("nombre_local").value;
	var direccion = document.getElementById("direccion").value;
	var comuna = document.getElementById("comuna").value;
	var nombre_contacto = document.getElementById("nombre_contacto").value;
	var telefono_contacto = document.getElementById("telefono_contacto").value;
	var tipo_canal = document.getElementById("tipo_canal").value;
	
	var formData = new FormData();
	formData.append("venta", venta);
	//formData.append("nombre_local", nombre_local);
	formData.append("direccion", direccion);
	formData.append("comuna", comuna);
	formData.append("nombre_contacto", nombre_contacto);
	formData.append("telefono_contacto", telefono_contacto);
	formData.append("tipo_canal", tipo_canal);
	formData.append("dato", dato);
	formData.append("usuario", nombre_usuario);
	$.ajax({
		type: 'POST',
		url: 'https://www.sistemalodis.cl/bodega_lodis_movil/checklist_comercio_guarda_dato_app.php',
		data: formData,
		processData: false,
		contentType: false,
		success: function (result) 
			{
				if (dato=='VENTA')
					{
					//document.form1.submit();
					}
			}
		});
	
	}

function procesar()
	{
	var venta=document.getElementById('venta').value;
	var direccion=document.getElementById('direccion').value;
	var comuna=document.getElementById('comuna').value;
	var nombre_contacto=document.getElementById('nombre_contacto').value;
	var telefono_contacto=document.getElementById('telefono_contacto').value;
	var tipo_canal=document.getElementById('tipo_canal').value;
	var id_comercio=document.getElementById('id_comercio').value;
	var productos=document.getElementById('total_productos').innerHTML;
	var num = parseInt(productos)
	var img = document.getElementById('photo');
	var tamanoh = img.naturalHeight;
	var tamanow = img.naturalWidth;
	var img2 = document.getElementById('photo2');
	var tamanoh2 = img2.height;
	var tamanow2 = img2.width;
	if (venta=='')
		{
		alert("Debe especificar si el comerciante vende Chip")
		}
	else if ((venta!='SI WOM')&&(num==0))
		{
		alert("Debe scanear los productos entregados")
		}
	else if (direccion=='')
		{
		alert("Debe especificar la direccion")
		}
	else if (comuna=='')
		{
		alert("Debe especificar la comuna")
		}
	else if((nombre_contacto==''))
		{
		alert("Debe especificar el nombre del contacto")
		}
	else if((telefono_contacto==''))
		{
		alert("Debe especificar el telefono de contacto")
		}
	else if((tipo_canal==''))
		{
		alert("Debe especificar el tipo de canal")
		}
	else if (tamanoh==0) 
		{
		alert("1.-Debe ingresar Foto 1")
		}
	else if (tamanoh2==0) 
		{
		alert("2.-Debe ingresar Foto 2")
		}
	else
		{
		//proceso de compresion imagen 1
		var canvasx = document.createElement("canvas");
		var tamanoh = img.naturalHeight;
		var tamanow = img.naturalWidth;
		if (tamanoh<tamanow)
			{
			canvasx.height = 800;
			var ancho=(tamanow*800)/tamanoh;
			canvasx.width = ancho;	
			}
		else
			{
			canvasx.height = 800;
			var ancho=(tamanow*800)/tamanoh;
			canvasx.width = ancho;	
			}
		context = canvasx.getContext('2d');
		context.drawImage(img, 0, 0, canvasx.width, canvasx.height);
		var dataURL = canvasx.toDataURL("image/jpeg",0.95);
		var blobBin = atob(dataURL.split(',')[1]);
		var array = [];
		for(var i = 0; i < blobBin.length; i++) 
			{
			array.push(blobBin.charCodeAt(i));
			}
		var file1=new Blob([new Uint8Array(array)], {type: 'image/jpeg'});
		// final de compresion imagen 1

		//proceso de compresion imagen 2
		var canvas2 = document.createElement("canvas");
		var tamanoh = img2.naturalHeight;
		var tamanow = img2.naturalWidth;
		if (tamanoh<tamanow)
			{
			canvas2.height = 800;
			var ancho=(tamanow*800)/tamanoh;
			canvas2.width = ancho;	
			}
		else
			{
			canvas2.height = 800;
			var ancho=(tamanow*800)/tamanoh;
			canvas2.width = ancho;	
			}
		context2 = canvas2.getContext('2d');
		context2.drawImage(img2, 0, 0, canvas2.width, canvas2.height);
		var dataURL = canvas2.toDataURL("image/jpeg",0.95);
		var blobBin = atob(dataURL.split(',')[1]);
		var array = [];
		for(var i = 0; i < blobBin.length; i++) 
			{
			array.push(blobBin.charCodeAt(i));
			}
		var file2=new Blob([new Uint8Array(array)], {type: 'image/jpeg'});
		// final de compresion imagen 2
		
		var dato='GUARDAR';
		var formData = new FormData();
		formData.append("venta", venta);
		//formData.append("nombre_local", nombre_local);
		formData.append("direccion", direccion);
		formData.append("comuna", comuna);
		formData.append("nombre_contacto", nombre_contacto);
		formData.append("telefono_contacto", telefono_contacto);
		formData.append("tipo_canal", tipo_canal);
		formData.append("dato", dato);
		formData.append("usuario", nombre_usuario);
		formData.append("myCanvas", file1);
		formData.append("myCanvas2", file2);
		formData.append("id_comercio", id_comercio);
		$.ajax({
			type: 'POST',
			url: 'https://www.sistemalodis.cl/bodega_lodis_movil/checklist_comercio_guarda_dato_app.php',
			data: formData,
			processData: false,
			contentType: false,
			success: function (result) 
				{
				document.getElementById('venta').value='';
				document.getElementById('direccion').value='';
				document.getElementById('nombre_contacto').value='';
				document.getElementById('telefono_contacto').value='';
				document.getElementById('tipo_canal').value='';
				document.getElementById('total_productos').innerHTML = '0';
				document.getElementById('foto1').value = '';
				document.getElementById('foto2').value = '';
				
				var vacio='';
					$('#venta').empty().append();
					$('#venta').append('<option value="'+vacio+'">'+vacio+'</option>');
					$('#venta').append('<option value="SI WOM">SI WOM</option>');
					$('#venta').append('<option value="NO WOM SI OTRAS TELCO">NO WOM SI OTRAS TELCO</option>');
					$('#venta').append('<option value="SOLO RECARGA">SOLO RECARGA</option>');
					$('#venta').selectmenu('refresh')
					$('#tipo_canal').empty().append();
					$('#tipo_canal').append('<option value="'+vacio+'">'+vacio+'</option>');
					$('#tipo_canal').append('<option value="ESPECIALISTA">ESPECIALISTA</option>');
					$('#tipo_canal').append('<option value="TRADICIONAL">TRADICIONAL</option>');
					$('#tipo_canal').append('<option value="KIOSCO">KIOSCO</option>');
					$('#tipo_canal').selectmenu('refresh')
				
				
				alert("Ingreso correcto")
		
				}
			});
		
		}
	
	}


</script>
<style>
.container2{
	overflow:auto;
	right: 0px;
	position: relative;
	background:none;
}
.borde_imagen {
background-color: #F5F5F5;
border: 5px solid #FFFFFF;
box-shadow: 0 0 22px #111111;
margin-top: 10px;
margin-bottom: 10px;
margin-right: 10px;
margin-left: 10px;
width:50%;

//position: relative;
	
}
</style>
</head>

<body>
<div data-role="page" id="comercio">
  <div data-role="header">
    <h1>Comercio</h1>
  </div>
  <div data-role="content">
    <div data-role="fieldcontain">
      <label for="venta" class="select">Vende Chip?</label>
      <select name="venta" id="venta" onChange="guardar_dato('VENTA')">
        <option value="SI WOM">SI WOM</option>
	    <option value="NO WOM SI OTRAS TELCO">NO WOM SI OTRAS TELCO</option>
	    <option value="SOLO RECARGA">SOLO RECARGA</option>
      </select>
      <input type="hidden" name="id_comercio" id="id_comercio" />
    </div>
    <div class="ui-grid-a" >
    	<div class="ui-block-a">
            <div style="line-height:60px; vertical-align:middle;">PRODUCTOS:  <span id="total_productos"></span>
            </div>
        </div>
        <div class="ui-block-b"><a href="#" onclick="carga_scanner()" data-role="button">Scan</a>
        </div>
    </div>

  <label for="direccion">Dirección:</label>
  <input type="text" name="direccion" id="direccion" value="" onBlur="guardar_dato('DIRECCION')" />
  
  <div data-role="fieldcontain">
    <label for="comuna" class="select">Comuna:</label>
    <select name="comuna" id="comuna" onChange="guardar_dato('COMUNA')">
      <option value="option1">Opción 1</option>
      <option value="option2">Opción 2</option>
      <option value="option3">Opción 3</option>
    </select>
  </div>
  
  <label for="nombre_contacto">Nombre Contacto:</label>
  <input type="text" name="nombre_contacto" id="nombre_contacto" onBlur="guardar_dato('NOMBRE_CONTACTO')" value=""  />
  <label for="telefono_contacto">Telefono Contacto:</label>
  <input type="text" name="telefono_contacto" id="telefono_contacto" onBlur="guardar_dato('TELEFONO_CONTACTO')" value=""  />
  
  <div data-role="fieldcontain">
    <label for="tipo_canal" class="select">Tipo Canal:</label>
    <select name="tipo_canal" id="tipo_canal" onChange="guardar_dato('TIPO_CANAL')">
      <option value="ESPECIALISTA">ESPECIALISTA</option>
      <option value="TRADICIONAL">TRADICIONAL</option>
      <option value="KIOSCO">KIOSCO</option>
    </select>
  </div>
  <!-- sección para la imagen 1-->
  <a href="#" data-role="button" id="takePhoto">TOMAR FOTO 1</a>
  <div class="container2" style="width:1px; height:1px">
  <img id="photo" src=""/>
  </div>
  <div style="text-align:center"><canvas id="foto1" class="borde_imagen"></canvas></div>
  <!-- sección para la imagen 1-->
  <!-- sección para la imagen 2-->
  <a href="#" data-role="button" id="takePhoto2">TOMAR FOTO 2</a>
  <div class="container2" style="width:1px; height:1px">
  <img id="photo2" src=""/>
  </div>
  <div style="text-align:center"><canvas id="foto2" class="borde_imagen"></canvas></div>
  <!-- sección para la imagen 2-->
                                        
  <a href="#" data-role="button" onclick="procesar()">Procesar</a>
<script type="text/javascript" src="cordova.js"></script>
<script type="text/javascript" src="js/camara.js"></script>
<script type="text/javascript">app.initialize();</script>

 
  </div>
    </div>
    <div>
    </div>
  </div>
  <div data-role="footer">
    <h4>Pie</h4>
  </div>
</div>

</body>
</html>
